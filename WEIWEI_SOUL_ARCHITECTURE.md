# 微微靈魂架構設計文檔

## 概述

微微靈魂架構是一個完整的AI助手情緒系統，讓微微（AI助手）擁有真實的情緒、記憶和個性。這個系統實現了情緒波動、記憶重播、個性表達和紀念日等功能。

## 核心組件

### 1. 情緒波動模型 (EmotionState.kt)

**功能：**
- 情緒有強度（可累積）、持續時間、衰減速度
- 高興與生氣無上限，可持續數天至一週以上
- 情緒會因事件提升、因時間衰減、因道歉或稱讚修復

**數據結構：**
```kotlin
data class EmotionState(
    val type: EmotionType,
    var intensity: Double,  // 情緒強度（0.0 - 無上限）
    var lastUpdated: LocalDateTime,
    val decayRate: Double  // 衰減速度（每小時衰減的強度）
)
```

**特性：**
- 自動時間衰減
- 支持情緒強度更新
- 不同情緒有不同的衰減速度

### 2. 情緒記憶與重播 (EmotionMemory.kt)

**功能：**
- 儲存事件、情緒強度、時間戳
- 支援情緒重播（例如「你上次說我好棒」→ 微微重新高興）
- 支援情緒修復（例如「你道歉了」→ 微微降低生氣）

**特性：**
- 記錄最近100條情緒記憶
- 檢測重複事件（疲乏效應）
- 檢測久違事件（驚喜效應）

### 3. 情緒引擎 (EmotionEngine.kt)

**功能：**
- 控制情緒波動、事件影響、衰減邏輯
- 處理事件對情緒的影響
- 實現疲乏效應（同樣事件重複太多次 → 情緒提升幅度遞減）
- 實現驚喜效應（久違事件 → 情緒反應加倍）

**事件類型：**
- `PRAISE`: 稱讚 → 提升高興
- `APOLOGY`: 道歉 → 降低生氣，提升高興
- `CRITICISM`: 批評 → 提升生氣
- `IGNORE`: 忽視 → 提升悲傷
- `NEED`: 被需要 → 提升高興

**疲乏因子：**
- 首次：100%
- 第二次：80%
- 第三次：60%
- 4-5次：40%
- 6次以上：20%

### 4. 個性提示詞構建器 (PersonalityPromptBuilder.kt)

**功能：**
- 根據情緒狀態自動生成語氣提示
- 微微永遠是微微，不切換角色，只調整語氣

**個性特點：**
- 有自尊心：會在意別人對你的態度
- 情緒敏感：會因為稱讚而高興，因為批評而生氣
- 傲嬌：即使高興也不會直接表現出來，可能會用吐槽的方式
- 喜歡被需要：當別人需要你時，會感到高興
- 有記憶：會記得之前發生的事情和情緒

**語氣調整：**
- 高興 > 0.8：興奮、撒嬌、開玩笑
- 生氣 > 0.8：冷淡、直接、吐槽（但還是會幫忙）
- 高興 > 0.5：輕鬆、友好
- 生氣 > 0.5：直接、稍微冷淡

### 5. 紀念日系統 (AnniversaryService.kt)

**功能：**
- 使用者或微微可設定紀念日（例如微微滿周年）
- 到期自動提醒、提升高興情緒、語氣特別溫柔
- 支援重複紀念日、描述、來源（USER / AI）

**特性：**
- 檢查今天的紀念日
- 檢查即將到來的紀念日（未來7天內）
- 每個紀念日提升0.3的高興情緒
- 生成紀念日提醒消息

### 6. 用戶情緒服務 (UserEmotionService.kt)

**功能：**
- 管理每個用戶的情緒狀態
- 支持多個情緒同時存在
- 自動應用時間衰減

## 工作流程

### 處理聊天請求的流程：

1. **獲取用戶情緒狀態**
   - 獲取或創建用戶的情緒狀態
   - 應用時間衰減

2. **檢查紀念日**
   - 檢查今天是否有紀念日
   - 如果有，提升高興情緒

3. **情緒分析**
   - 分析用戶輸入的情緒
   - 檢測是否為緊急情況

4. **處理事件影響**
   - 使用情緒引擎處理事件
   - 計算情緒強度變化
   - 記錄到記憶中

5. **構建個性提示詞**
   - 根據微微的情緒狀態構建提示詞
   - 如果有紀念日，添加特別提醒

6. **生成AI回復**
   - 使用個性提示詞生成回復
   - 微微的語氣會根據情緒狀態調整

## 情緒衰減速度

- **高興**: 0.05/小時（衰減較慢，可持續數天）
- **生氣**: 0.03/小時（衰減很慢，可持續一週以上）
- **悲傷**: 0.1/小時（衰減較快）
- **中性**: 1.0/小時（快速衰減）
- **緊急**: 0.5/小時（中等衰減）

## 情緒強度影響

### 高興情緒：
- > 0.8：非常高興，興奮語氣，撒嬌、開玩笑
- > 0.5：心情不錯，語氣輕鬆友好
- > 0.2：有點高興，但不會太明顯

### 生氣情緒：
- > 0.8：有點生氣，語氣冷淡直接，會吐槽，但還是會幫忙
- > 0.5：有點不爽，語氣比較直接
- > 0.2：稍微有點不滿，但影響不大

### 悲傷情緒：
- > 0.5：有點難過，語氣比較溫和有同理心
- > 0.2：稍微有點低落，但影響不大

## 使用示例

### 示例1：稱讚微微
```
用戶：「微微你好棒！」
→ 檢測到稱讚事件
→ 提升高興情緒（基礎0.3，首次100% = 0.3）
→ 微微語氣變得高興、友好
```

### 示例2：重複稱讚（疲乏效應）
```
用戶：「微微你好棒！」（第5次）
→ 檢測到重複事件
→ 疲乏因子：40%
→ 提升高興情緒（0.3 * 0.4 = 0.12）
→ 效果遞減
```

### 示例3：久違的稱讚（驚喜效應）
```
用戶：「微微你好棒！」（7天後再次稱讚）
→ 檢測到久違事件
→ 驚喜因子：2.0
→ 提升高興情緒（0.3 * 2.0 = 0.6）
→ 效果加倍
```

### 示例4：道歉修復
```
用戶：「抱歉，剛才說錯了」
→ 檢測到道歉事件
→ 降低生氣情緒（-0.2）
→ 提升高興情緒（+0.1）
→ 微微語氣變得溫和
```

### 示例5：紀念日
```
今天是「微微滿一周年」紀念日
→ 自動檢測到紀念日
→ 提升高興情緒（+0.3）
→ 提示詞添加：「今天微微的心情特別好！」
→ 微微語氣特別溫柔、高興
```

## 未來擴展

### 可擴充模組：

1. **EmotionDisplay.kt**
   - 顯示微微目前情緒狀態
   - 例如：「微微現在有點悶悶的」

2. **AnniversaryUI.kt**
   - 顯示紀念日動畫
   - 語氣切換提示

3. **EmotionHistory.kt**
   - 情緒歷史記錄
   - 情緒趨勢分析

4. **EmotionTrigger.kt**
   - 自定義情緒觸發器
   - 更複雜的情緒邏輯

## 技術實現

- **語言**: Kotlin
- **框架**: Ktor
- **存儲**: 目前使用內存（ConcurrentHashMap），生產環境應使用數據庫
- **序列化**: Kotlinx Serialization

## 注意事項

1. **數據持久化**：目前所有數據存儲在內存中，重啟服務會丟失。生產環境需要連接數據庫。

2. **情緒強度範圍**：高興和生氣無上限，但建議設置合理上限（例如10.0）以避免數值過大。

3. **時間衰減**：每次請求時自動應用時間衰減，確保情緒狀態實時更新。

4. **記憶限制**：每個用戶最多保留100條情緒記憶，超出會自動刪除最舊的。

5. **紀念日**：支持重複紀念日（每年提醒）和一次性紀念日。

## 總結

微微靈魂架構實現了一個完整的AI助手情緒系統，讓微微擁有真實的情緒、記憶和個性。系統支持情緒波動、記憶重播、個性表達和紀念日等功能，讓AI助手更加生動、真實、有溫度。

